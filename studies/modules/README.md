# Modules Overview

This directory contains helper modules used for strategy research.

## Labeling Functions

The file `labeling_lib.py` exposes a variety of `get_labels_*` functions. Each one generates buy/sell labels in a different way. The table below summarizes their purpose.

| Function | Purpose |
| --- | --- |
| `get_labels_one_direction` | ATR‑based labeling of long/short trades within a look‑ahead window. Can label one or both directions. |
| `get_labels_trend` | Labels trades when the price trend normalized by volatility exceeds a threshold. |
| `get_labels_trend_with_profit` | Like `get_labels_trend` but only keeps signals that achieve a minimum markup (ATR multiple) within a future window. |
| `get_labels_trend_with_profit_different_filters` | Trend labeling with multiple smoothing methods (savgol, spline, etc.) and ATR-based markup. |
| `get_labels_trend_with_profit_multi` | Combines several smoothing windows and requires a markup (ATR multiple) to be hit. |
| `get_labels_clusters` | Uses K‑Means clusters of closing prices and labels when switching clusters with sufficient price movement (markup * ATR). |
| `get_labels_multi_window` | Generates breakout labels from multiple support/resistance windows. |
| `get_labels_validated_levels` | Similar to `get_labels_multi_window` but requires several touches to validate levels. |
| `get_labels_filter_ZZ` | Zigzag peak/trough detection to label local highs and lows. |
| `get_labels_mean_reversion` | Mean‑reversion labeling based on deviations from a smoothed trend. | Uses markup multiplied by ATR.
| `get_labels_mean_reversion_multi` | Mean‑reversion using multiple smoothing windows. | Uses markup multiplied by ATR.
| `get_labels_mean_reversion_v` | Mean‑reversion with volatility bands to adapt quantiles. | Uses markup multiplied by ATR.
| `get_labels_filter` | Generates labels when price deviates from a Savitzky–Golay filter. |
| `get_labels_multiple_filters` | Combines several filters and rolling quantiles for multi‑timeframe signals. |
| `get_labels_filter_bidirectional` | Uses two Savitzky–Golay filters (forward/backward) and labels when price deviates from both. |
| `get_labels_filter_one_direction` | A single direction variant of `get_labels_filter`. |
| `get_labels_trend_one_direction` | Trend labeling for only buy or sell signals. |
| `get_labels_filter_flat` | Detects flat periods using the inverse of a filtered deviation. |

## Using `StrategySearcher`

`StrategySearcher` accepts a `label_method` parameter. This string selects any of the labeling functions above via an internal map. By default it uses `"atr"` which maps to `get_labels_one_direction`.

Label generation is always stochastic when a look-ahead window is involved. Previous deterministic behaviour has been removed and all labeling functions that required a random choice of future bar now select it randomly.

The parameters `markup`, `label_max` and `atr_period` are suggested by Optuna only when the chosen labeling function defines arguments with those names. For example `get_labels_one_direction` and the mean reversion variants all require `markup` and a forward looking window (`max_val`/`max_l`). Trend based labelers usually only use a smoothing window and threshold, so those hyperparameters are ignored during optimization.

Example:

```python
from datetime import datetime
from studies.modules.StrategySearcher import StrategySearcher

searcher = StrategySearcher(
    symbol="EURUSD",
    timeframe="H1",
    direction="buy",
    train_start=datetime(2020, 1, 1),
    train_end=datetime(2020, 6, 1),
    test_start=datetime(2020, 6, 1),
    test_end=datetime(2020, 12, 1),
    label_method="trend_profit",  # use get_labels_trend_with_profit
)

searcher.run_search()
```

The `label_method` can be any key from the map defined in `StrategySearcher.LABEL_FUNCS` such as `"trend"`, `"mean_rev"`, `"multi_filter"`, etc.

### LGMM search type

`StrategySearcher` also supports a lightweight Gaussian Mixture clustering mode using `search_type="lgmm"`. The main and meta models are trained for each cluster generated by scikit‑learn's `GaussianMixture`.

```python
searcher = StrategySearcher(
    symbol="EURUSD",
    timeframe="H1",
    direction="buy",
    train_start=datetime(2020, 1, 1),
    train_end=datetime(2020, 6, 1),
    test_start=datetime(2020, 6, 1),
    test_end=datetime(2020, 12, 1),
    search_type="lgmm",
)
```
